<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesamiento SAT/IMMEX</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .progress {
            height: 25px;
            margin: 10px 0;
        }
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            min-height: 50px;
        }
        .btn-process {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            margin: 5px 0;
        }
        .file-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center">Procesamiento Automatizado SAT/IMMEX</h1>
                <p class="text-center text-muted">Ejecuta los procesos de descarga, extracción y cruce de datos desde aquí</p>
                <p class="text-center text-muted">(cada proceso tarda 20 min. aproximadamente)</p>
            </div>
        </div>

        <div class="row">
            <!-- Parte A: Padrón de Importadores -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Parte A: Padrón de Importadores</h4>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Descarga el PDF del padrón de importadores del SAT y conviértalo a CSV.</p>
                        
                        <div class="file-info" id="file-info-a">
                            <small>Archivo no generado aún</small>
                        </div>
                        
                        <div class="status-message alert alert-info" id="status-a">
                            Listo para ejecutar
                        </div>
                        
                        <div class="progress" id="progress-a-container" style="display: none;">
                            <div id="progress-a" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                        
                        <button class="btn btn-primary btn-process" onclick="runProcess('parte_a')" id="btn-run-a">
                            Ejecutar Parte A
                        </button>
                        
                        <button class="btn btn-success btn-process" onclick="downloadFile('parte_a')" 
                                id="btn-download-a" disabled style="display: none;">
                            Descargar CSV
                        </button>
                    </div>
                </div>
            </div>

            <!-- Parte B: IMMEX con RFC -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Parte B: IMMEX + RFC</h4>
                    </div>
                    <div class="card-body">
                        <p class="card-text">Descarga el directorio de IMMEX y realice cruce con el padrón para asignar RFC.</p>
                        
                        <div class="file-info" id="file-info-b">
                            <small>Archivo no generado aún</small>
                        </div>
                        
                        <div class="status-message alert alert-info" id="status-b">
                            Listo para ejecutar
                        </div>
                        
                        <div class="progress" id="progress-b-container" style="display: none;">
                            <div id="progress-b" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                        
                        <button class="btn btn-success btn-process" onclick="runProcess('parte_b')" id="btn-run-b">
                            Ejecutar Parte B
                        </button>
                        
                        <button class="btn btn-success btn-process" onclick="downloadFile('parte_b')" 
                                id="btn-download-b" disabled style="display: none;">
                            Descargar CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // Estado inicial
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingFiles();
            setInterval(checkExistingFiles, 5000); // Revisar cada 5 segundos
        });

        // Verificar archivos existentes
        async function checkExistingFiles() {
            try {
                const response = await fetch('/api/files/exist');
                const files = await response.json();
                
                updateFileInfo('parte_a', files.parte_a);
                updateFileInfo('parte_b', files.parte_b);
                
                if (files.parte_a) enableDownload('parte_a');
                if (files.parte_b) enableDownload('parte_b');
            } catch (error) {
                console.error('Error al verificar archivos:', error);
            }
        }

        // Actualizar información de archivo
        function updateFileInfo(processId, exists) {
            const infoElement = document.getElementById(`file-info-${processId.slice(-1)}`);
            if (exists) {
                infoElement.innerHTML = `<strong>Archivo disponible</strong><br>
                                        <small>Haz clic en "Descargar CSV" para obtenerlo</small>`;
                infoElement.className = 'file-info alert alert-success';
            } else {
                infoElement.innerHTML = '<small>Archivo no generado aún</small>';
                infoElement.className = 'file-info';
            }
        }

        // Ejecutar proceso
        async function runProcess(processId) {
            const btnRun = document.getElementById(`btn-run-${processId.slice(-1)}`);
            const statusElement = document.getElementById(`status-${processId.slice(-1)}`);
            const progressContainer = document.getElementById(`progress-${processId.slice(-1)}-container`);
            const progressBar = document.getElementById(`progress-${processId.slice(-1)}`);
            
            // Deshabilitar botón
            btnRun.disabled = true;
            btnRun.innerHTML = 'Ejecutando...';
            
            // Mostrar barra de progreso
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.innerHTML = '0%';
            
            // Iniciar proceso
            try {
                const response = await fetch(`/api/run/${processId}`, { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    statusElement.className = 'status-message alert alert-info';
                    statusElement.innerHTML = 'Iniciando proceso...';
                    
                    // Monitorear progreso cada segundo
                    const progressInterval = setInterval(async () => {
                        const statusResponse = await fetch(`/api/status/${processId}`);
                        const status = await statusResponse.json();
                        
                        // Actualizar interfaz
                        statusElement.innerHTML = status.message;
                        progressBar.style.width = `${status.progress}%`;
                        progressBar.innerHTML = `${status.progress}%`;
                        
                        // Si terminó
                        if (!status.running) {
                            clearInterval(progressInterval);
                            
                            // Actualizar botones
                            btnRun.disabled = false;
                            btnRun.innerHTML = 'Volver a ejecutar';
                            
                            // Ocultar barra después de 3 segundos
                            setTimeout(() => {
                                progressContainer.style.display = 'none';
                            }, 3000);
                            
                            // Si tuvo éxito, habilitar descarga
                            if (status.progress === 100) {
                                statusElement.className = 'status-message alert alert-success';
                                enableDownload(processId);
                                checkExistingFiles(); // Actualizar lista de archivos
                            } else {
                                statusElement.className = 'status-message alert alert-danger';
                            }
                        }
                    }, 1000);
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (error) {
                statusElement.className = 'status-message alert alert-danger';
                statusElement.innerHTML = `Error: ${error.message}`;
                btnRun.disabled = false;
                btnRun.innerHTML = 'Ejecutar de nuevo';
                progressContainer.style.display = 'none';
            }
        }

        // Habilitar botón de descarga
        function enableDownload(processId) {
            const btnDownload = document.getElementById(`btn-download-${processId.slice(-1)}`);
            btnDownload.disabled = false;
            btnDownload.style.display = 'block';
        }

        // Descargar archivo
        function downloadFile(processId) {
            window.location.href = `/api/download/${processId}`;
        }
    </script>
</body>
</html>